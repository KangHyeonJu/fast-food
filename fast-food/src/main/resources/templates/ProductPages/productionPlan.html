<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout1}">

<div layout:fragment="content">
    <style>
        .button-container {
            display: flex;
            justify-content: flex-end; /* 왼쪽 정렬 */
            margin-bottom: 10px;
        }

        .button-container button {
            margin-left: 10px; /* 버튼 사이의 간격 조정 */
        }

        .form-group label {
            margin-right: 10px;
        }

        .form-control {
            width: 150px;
            margin-right: 10px;
            display: inline-block;
        }

        hr {
            margin-top: 10px;
        }
    </style>
    <!-- Page Content -->
    <div id="page-wrapper">
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-12">
                    <h1 class="page-header">작업 계획 관리</h1>
                </div>
                <!-- /.col-lg-12 -->
            </div>
            <!-- /.row -->

            <!-- 버튼 모음 -->
            <div class="list-inline text-right">
                <button id="excelExportBtn" type="button" class="btn btn-success">엑셀 저장</button>
            </div>
            <!--버튼끝-->

            <br/>

            <!-- 조회 -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="panel panel-default">
                        <div class="panel-body">
                            <form th:action="@{/machine/searchProductionPlan}" method="get">
                                <div class="form-group">
                                    <ul class="list-inline" style="margin-bottom: 0">
                                        <li>
                                            <label>생산 코드 : </label><input class="form-control" name="pmCode">
                                        </li>
                                        <li>
                                            <label>생산 시작일 :
                                                <input class="form-control" type="date" id="startTime" name="startTime">
                                            </label>
                                        </li>
                                        <li>
                                            <label>생산품 :
                                                <select name="itName" class="form-control">
                                                    <option value="">전체</option>
                                                    <option th:each="item : ${items}" th:value="${item.itName}"
                                                            th:text="${item.itName}"></option>
                                                </select>
                                            </label>
                                        </li>
                                        <li>
                                            <button class="btn btn-primary">조회</button>
                                        </li>
                                    </ul>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

            </div>
            <!-- 조회 끝-->

            <br/>

            <!-- 테이블 1 -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4>생산 계획 테이블</h4>
                        </div>
                        <!-- /.panel-heading -->
                        <div class="panel-body" style="height: 300px; overflow: auto">
                            <table class="table table-striped table-bordered table-hover" id="dataTables-example"
                                   style="width: 100%; font-size: large">
                                <thead>
                                <tr>
                                    <th><input type="checkbox" id="checkall"></th>
                                    <th>생산 코드</th>
                                    <th>생산 시작일</th>
                                    <th>생산 종료일</th>
                                    <th>생산품</th>
                                    <th>생산 목표량 [낱개]</th>
                                </tr>
                                </thead>
                                <tbody>
                                <!-- 생산계획만큼 반복문으로 데이터 받아옴 controller에서 받아와야함 -->
                                <tr class="pmList" th:each="production : ${productions}">
                                    <td><input type="checkbox" class="planCheckbox" th:value="${production.pmCode}"></td>
                                    <td th:text="${production.pmCode}" onclick="fetchWorksData(this);"></td>
                                    <!-- 생산 시작일 = (납품요청일) - 1일 - (생산 소요 시간)  -->
                                    <td th:text="${production.pmSDate}"></td>
                                    <!-- 생산 종료일 = (납품요청일) - 1일 -->
                                    <td th:text="${production.pmEDate}"></td>
                                    <!-- 생산품명 -->
                                    <td th:text="${production.itName}"></td>
                                    <!-- 생산량목표량 = 수주량 -->
                                    <td th:text="${production.pmAmount}"></td>
                                </tr>
                                </tbody>
                            </table>
                            <!-- /.table-responsive -->
                        </div>
                        <!-- /.panel-body -->
                    </div>
                    <!-- /.panel -->
                </div>

                <!-- /.col-lg-12 -->
            </div>

            <!-- 테이블 1 끝-->
            <br/>

            <!--테이블 2 -->
            <!--            <div class="row">-->
            <!--                <div class="col-lg-12">-->
            <!--                    <div class="panel panel-default">-->
            <!--                        <div class="panel-heading">-->
            <!--                            생산 계획 테이블-->
            <!--                        </div>-->
            <!--                        &lt;!&ndash; /.panel-heading &ndash;&gt;-->
            <!--                        <div class="panel-body" style="height: 300px; overflow: auto">-->
            <!--                            <table class="table table-striped table-bordered table-hover" style="width: 100%;">-->
            <!--                                <thead>-->
            <!--                                <tr>-->
            <!--                                    <th>작업 지시 코드</th>-->
            <!--                                    <th>작업 시작일</th>-->
            <!--                                    <th>작업 종료일</th>-->
            <!--                                </tr>-->
            <!--                                </thead>-->
            <!--                                <tbody>-->
            <!--                                <tr th:each="work : ${works}">-->
            <!--                                    <td th:text="${work.wkCode}"></td>-->
            <!--                                    <td th:text="${work.SDate}"></td>-->
            <!--                                    <td th:text="${work.EDate}"></td>-->
            <!--                                </tr>-->
            <!--                                </tbody>-->
            <!--                            </table>-->
            <!--                            &lt;!&ndash; /.table-responsive &ndash;&gt;-->
            <!--                        </div>-->
            <!--                        &lt;!&ndash; /.panel-body &ndash;&gt;-->
            <!--                    </div>-->
            <!--                    &lt;!&ndash; /.panel &ndash;&gt;-->
            <!--                </div>-->
            <!--                &lt;!&ndash; /.col-lg-12 &ndash;&gt;-->
            <!--            </div>-->
            <!--테이블 2 -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="panel panel-default" id="panelshow">
                        <div class="panel-heading">
                            <h4>작업 계획 테이블</h4>
                        </div>
                        <!-- /.panel-heading -->
                        <div class="panel-body" style="height: 300px; overflow: auto">
                            <table class="table table-striped table-bordered table-hover" id="table3-body"
                                   style="width: 100%; font-size: large">
                                <thead>
                                <tr>
                                    <th>작업 지시 코드</th>
                                    <th>작업 시작일</th>
                                    <th>작업 종료일</th>
                                </tr>
                                </thead>
                                <tbody>

                                </tbody>
                            </table>
                            <!-- /.table-responsive -->
                        </div>
                        <!-- /.panel-body -->
                    </div>
                    <!-- /.panel -->
                </div>
                <!-- /.col-lg-12 -->
            </div>
        </div>
        <!-- /.container-fluid -->
    </div>
    <!-- /#page-wrapper -->

</div>
<!-- /#wrapper -->


<th:block layout:fragment="script">
    <script>
        $(document).ready(function () {
            $('#excelExportBtn').click(function () {
                var selectedproductPlan = [];
                $('input.planCheckbox:checked').each(function () {
                    selectedproductPlan.push($(this).val());
                });

                if (selectedproductPlan.length === 0) {
                    alert('선택된 작업 계획이 없습니다.');
                    return;
                }

                var form = $('<form action="/machine/productPlan/export/excel" method="POST"></form>');
                for (var i = 0; i < selectedproductPlan.length; i++) {
                    form.append('<input type="hidden" name="pmCode" value="' + selectedproductPlan[i] + '">');
                }

                $('body').append(form);

                // 폼을 명시적으로 제출합니다.
                form.submit();
            });
            $('#checkall').click(function () {
                $('input:checkbox').not(this).prop('checked', this.checked);
            });
        });

        function fetchWorksData(cell) {
            var pmCode = cell.textContent.trim(); // 클릭된 셀의 pmCode 값 가져오기
            var data = {pmCode: pmCode};

            // AJAX 요청을 통해 백엔드로 pmCode 전송
            $.ajax({
                type: "GET",
                url: "/machine/fetchWorksData",
                data: {pmCode: pmCode},
                contentType: 'application/json',
                success: function (response) {
                    function formatDateTime(dateTimeStr) {
                        const date = new Date(dateTimeStr);
                        const year = date.getFullYear();
                        const month = ('0' + (date.getMonth() + 1)).slice(-2);
                        const day = ('0' + date.getDate()).slice(-2);
                        const hours = ('0' + date.getHours()).slice(-2);
                        const minutes = ('0' + date.getMinutes()).slice(-2);

                        return `${year}-${month}-${day} ${hours}:${minutes}`;
                    }

                    var tableBody = document.getElementById("table3-body").getElementsByTagName('tbody')[0];
                    tableBody.innerHTML = ""; // 기존 데이터 지우기

                    console.log(response);
                    $.each(response, function (work, index) {
                        console.log(index);
                        console.log(work);
                        var row = "<tr>" +
                            "<td>" + index.wkCode + "</td>" +
                            "<td class='date-format'>" + index.sdate + "</td>" +
                            "<td class='date-format'>" + index.edate + "</td>" +
                            "</tr>";
                        tableBody.innerHTML += row;

                        const dateElements = document.querySelectorAll('.date-format');
                        dateElements.forEach(element => {
                            const formattedDate = formatDateTime(element.textContent);
                            element.textContent = formattedDate;
                        });
                    });
                },
                error: function (request, status, error) {
                    alert("데이터를 가져오는 중 오류가 발생했습니다.");
                    alert("code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
                }
            });
        }
    </script>
</th:block>
</html>
